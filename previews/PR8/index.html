<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Home · Armon.jl</title><meta name="title" content="Home · Armon.jl"/><meta property="og:title" content="Home · Armon.jl"/><meta property="twitter:title" content="Home · Armon.jl"/><meta name="description" content="Documentation for Armon.jl."/><meta property="og:description" content="Documentation for Armon.jl."/><meta property="twitter:description" content="Documentation for Armon.jl."/><script data-outdated-warner src="assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="assets/documenter.js"></script><script src="search_index.js"></script><script src="siteinfo.js"></script><script src="../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href>Armon.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li class="is-active"><a class="tocitem" href>Home</a><ul class="internal"><li><a class="tocitem" href="#Parameters-and-entry-point"><span>Parameters and entry point</span></a></li><li><a class="tocitem" href="#Grid-and-blocks"><span>Grid and blocks</span></a></li><li><a class="tocitem" href="#Device-and-backends"><span>Device and backends</span></a></li><li><a class="tocitem" href="#Kernels"><span>Kernels</span></a></li><li><a class="tocitem" href="#Utility"><span>Utility</span></a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Home</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Home</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/Keluaa/Armon.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/Keluaa/Armon.jl/blob/main/docs/src/index.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Armon"><a class="docs-heading-anchor" href="#Armon">Armon</a><a id="Armon-1"></a><a class="docs-heading-anchor-permalink" href="#Armon" title="Permalink"></a></h1><p>Documentation for <a href="https://github.com/Keluaa/Armon.jl">Armon</a>.</p><p>Armon is a 2D CFD solver for compressible non-viscous fluids, using the finite volume method.</p><p>It was made to explore Julia&#39;s capabilities in HPC and for performance portability: it should perform very well on any CPU and GPU. Domain decomposition using MPI is supported.</p><p>The twin project <a href="https://github.com/Keluaa/Armon-Kokkos">Armon-Kokkos</a> is a mirror of the core of this solver (with much less options) written in C++ using the Kokkos library. It is possible to reuse kernels from that solver in this one, using the <a href="https://github.com/Keluaa/Kokkos.jl">Kokkos.jl</a> package.</p><h2 id="Parameters-and-entry-point"><a class="docs-heading-anchor" href="#Parameters-and-entry-point">Parameters and entry point</a><a id="Parameters-and-entry-point-1"></a><a class="docs-heading-anchor-permalink" href="#Parameters-and-entry-point" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.ArmonParameters" href="#Armon.ArmonParameters"><code>Armon.ArmonParameters</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">ArmonParameters(; options...)</code></pre><p>The parameters and current state of the solver.</p><p>The state is reset at each call to <a href="#Armon.armon"><code>armon</code></a>.</p><p>There are many options. Each backend can add their own.</p><p><strong>Options</strong></p><p><strong>Backend and MPI</strong></p><pre><code class="nohighlight hljs">device = :CUDA</code></pre><p>Device to use. Supported values:</p><ul><li><code>:CPU_HP</code>: <code>Polyester.jl</code> CPU multithreading  (default if <code>use_gpu=false</code>)</li><li><code>:CUDA</code>: <code>CUDA.jl</code> GPU (default if <code>use_gpu=true</code>)</li><li><code>:ROCM</code>: <code>AMDGPU.jl</code> GPU</li><li><code>:CPU</code>: <code>KernelAbstractions.jl</code> CPU multithreading (using the standard <code>Threads.jl</code>)</li></ul><pre><code class="nohighlight hljs">use_MPI = true, P = (1, 1), reorder_grid = true, global_comm = nothing</code></pre><p>MPI config. The MPI domain will be a process grid of size <code>P</code>. <code>global_comm</code> is the global communicator to use, defaults to <code>MPI.COMM_WORLD</code>. <code>reorder_grid</code> is passed to <code>MPI.Cart_create</code>.</p><p><strong>Kernels</strong></p><pre><code class="nohighlight hljs">use_threading = true, use_simd = true</code></pre><p>Switches for <a href="#Armon.CPU_HP"><code>CPU_HP</code></a> kernels. <code>use_threading</code> enables <a href="#Armon.@threaded"><code>@threaded</code></a> for outer loops. <code>use_simd</code> enables <a href="#Armon.@simd_loop"><code>@simd_loop</code></a> for inner loops.</p><pre><code class="nohighlight hljs">use_gpu = false</code></pre><p>Enables the use of <code>KernelAbstractions.jl</code> kernels.</p><pre><code class="nohighlight hljs">use_kokkos = false</code></pre><p>Use kernels for <code>Kokkos.jl</code>.</p><pre><code class="nohighlight hljs">use_cache_blocking = true</code></pre><p>Separate the domain into semi-independant blocks, improving the cache-locality of memory accesses and therefore memory throughput.</p><pre><code class="nohighlight hljs">block_size = 1024</code></pre><p>Size of blocks for cache blocking. Can be a tuple. If <code>use_cache_blocking == false</code>, this option only controls the size of GPU blocks.</p><pre><code class="nohighlight hljs">use_two_step_reduction = false</code></pre><p>Reduction kernels (<code>dtCFL_kernel</code> and <code>conservation_vars</code>) use some optimizations to perform the reduction in a single step. It might cause issues on some GPU backends: a more &quot;gentle&quot; approach could avoid those by doing it in two steps.</p><p><strong>Profiling</strong></p><pre><code class="nohighlight hljs">profiling = Symbol[]</code></pre><p>List of profiling callbacks to use:</p><ul><li><code>:TimerOutputs</code>: <code>TimerOutputs.jl</code> sections (added if <code>measure_time=true</code>)</li><li><code>:NVTX_sections</code>: <code>NVTX.jl</code> sections</li><li><code>:NVTX_kernels</code>: <code>NVTX.jl</code> sections for kernels</li><li><code>:CUDA_kernels</code>: equivalent to <code>CUDA.@profile</code> in front of all kernels</li></ul><pre><code class="nohighlight hljs">measure_time = true</code></pre><p><code>measure_time=false</code> can remove any overhead caused by profiling.</p><pre><code class="nohighlight hljs">time_async = true</code></pre><p><code>time_async=false</code> will add a barrier at the end of every section. Useful for GPU kernels.</p><p><strong>Scheme and CFD solver</strong></p><pre><code class="nohighlight hljs">scheme = :GAD, riemann_limiter = :minmod</code></pre><p><code>scheme</code> is the Riemann solver scheme to use:</p><ul><li><code>:Godunov</code> (1st order)</li><li><code>:GAD</code> (2nd order, with limiter).</li></ul><p><code>riemann_limiter</code> is the limiter to use for the Riemann solver: <code>:no_limiter</code>, <code>:minmod</code> or <code>:superbee</code>.</p><pre><code class="nohighlight hljs">projection = :euler_2nd</code></pre><p>Scheme for the Eulerian remap step:</p><ul><li><code>:euler</code> (1st order)</li><li><code>:euler_2nd</code> (2nd order, +minmod limiter)</li></ul><pre><code class="nohighlight hljs">axis_splitting = :Sequential</code></pre><p>Axis splitting to use:</p><ul><li><code>:Sequential</code>: X then Y</li><li><code>:SequentialSym</code>: X and Y then Y and X, alternating</li><li><code>:Strang</code>: ½X, Y, ½X then ½Y, X, ½Y, alternating (½ is for halved time step)</li><li><code>:X_only</code></li><li><code>:Y_only</code></li></ul><pre><code class="nohighlight hljs">N = (10, 10)</code></pre><p>Number of cells of the global domain in each axes.</p><pre><code class="nohighlight hljs">nghost = 4</code></pre><p>Number of ghost cells. Must be greater or equal to the minimum number of ghost cells (min 1, <code>scheme=:GAD</code> adds one, <code>projection=:euler_2nd</code> adds one, <code>scheme=:GAD</code> + <code>projection=:euler_2nd</code> adds another one)</p><pre><code class="nohighlight hljs">Dt = 0., cst_dt = false, dt_on_even_cycles = false</code></pre><p><code>Dt</code> is the initial time step, it is computed after initialization by default. If <code>cst_dt=true</code> then the time step is always <code>Dt</code> and no reduction over the entire domain occurs.  If <code>dt_on_even_cycles=true</code> then then time step is only updated at even cycles (the first cycle is even).</p><pre><code class="nohighlight hljs">data_type = Float64</code></pre><p>Data type for all variables. Should be an <code>AbstractFloat</code>.</p><p><strong>Test case and domain</strong></p><pre><code class="nohighlight hljs">test = :Sod, domain_size = nothing, origin = nothing</code></pre><p><code>test</code> is the test case name to use:</p><ul><li><code>:Sod</code>: Sod shock tube test</li><li><code>:Sod_y</code>: Sod shock tube test along the Y axis</li><li><code>:Sod_circ</code>: Circular Sod shock tube test (centered in the domain)</li><li><code>:Bizarrium</code>: Bizarrium test, similar to the Sod shock tube but with a special equation of state</li><li><code>:Sedov</code>: Sedov blast-wave test (centered in the domain, reaches the border at <code>t=1</code> by default)</li><li><code>:DebugIndexes</code>: Set all variables to their index in the global domain. Debug only.</li></ul><pre><code class="nohighlight hljs">cfl = 0., maxtime = 0., maxcycle = 500_000</code></pre><p><code>cfl</code> defaults to the test&#39;s default value, same for <code>maxtime</code>. The solver stops when <code>t</code> reaches <code>maxtime</code> or <code>maxcycle</code> iterations were done (<code>maxcycle=0</code> stops after initialization).</p><p><strong>Output</strong></p><pre><code class="nohighlight hljs">silent = 0</code></pre><p><code>silent=0</code> for maximum verbosity. <code>silent=3</code> doesn&#39;t print info at each cycle. <code>silent=5</code> doesn&#39;t print anything.</p><pre><code class="nohighlight hljs">output_dir = &quot;.&quot;, output_file = &quot;output&quot;</code></pre><p><code>joinpath(output_dir, output_file)</code> will be path to the output file.</p><pre><code class="nohighlight hljs">write_output = false, write_ghosts = false</code></pre><p><code>write_output=true</code> will write all <code>saved_vars()</code> to the output file. If <code>write_ghosts=true</code>, ghost cells will also be included.</p><pre><code class="nohighlight hljs">write_slices = false</code></pre><p>Will write all <code>saved_vars()</code> to 3 output files, one for the middle X row, another for the middle Y column, and another for the diagonal. If <code>write_ghosts=true</code>, ghost cells will also be included.</p><pre><code class="nohighlight hljs">output_precision = nothing</code></pre><p>Numbers are saved with <code>output_precision</code> digits of precision. Defaults to enough numbers for an exact decimal representation.</p><pre><code class="nohighlight hljs">animation_step = 0</code></pre><p>If <code>animation_step ≥ 1</code>, then every <code>animation_step</code> cycles, variables will be saved as with <code>write_output=true</code>.</p><pre><code class="nohighlight hljs">compare = false, is_ref = false, comparison_tolerance = 1e-10</code></pre><p>If <code>compare=true</code>, then at every sub step of each iteration of the solver all variables will:</p><ul><li>(<code>is_ref=false</code>) be compared with a reference file found in <code>output_dir</code></li><li>(<code>is_ref=true</code>) be saved to a reference file in <code>output_dir</code></li></ul><p>When comparing, a relative <code>comparison_tolerance</code> (the <code>rtol</code> kwarg of <code>isapprox</code>) is accepted between values.</p><pre><code class="nohighlight hljs">check_result = false</code></pre><p>Check if conservation of mass and energy is verified between initialization and the last iteration. An error is thrown otherwise. Accepts a relative <code>comparison_tolerance</code>.</p><pre><code class="nohighlight hljs">return_data = false</code></pre><p>If <code>return_data=true</code>, then in the <a href="#Armon.SolverStats"><code>SolverStats</code></a> returned by <a href="#Armon.armon"><code>armon</code></a>, the <code>data</code> field will contain the <a href="#Armon.BlockGrid"><code>BlockGrid</code></a> used by the solver.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/parameters.jl#L6-L225">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.armon" href="#Armon.armon"><code>Armon.armon</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">armon(::ArmonParameters)</code></pre><p>Main entry point of the solver. Returns a <a href="#Armon.SolverStats"><code>SolverStats</code></a>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/solver.jl#L152-L156">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.SolverStats" href="#Armon.SolverStats"><code>Armon.SolverStats</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">SolverStats</code></pre><p>Solver output.</p><p><code>data</code> is nothing if <code>parameters.return_data</code> is <code>false</code>.</p><p><code>timer</code> is nothing if <code>parameters.measure_time</code> is <code>false</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/solver.jl#L2-L10">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.StepsRanges" href="#Armon.StepsRanges"><code>Armon.StepsRanges</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">StepsRanges</code></pre><p>Holds indexing information for all steps of the solver.</p><p>Domains are stored as block corner offsets: blocks can have different sizes, but always the same amount of ghost cells, therefore the iteration domain is determined from the dimensions of the block. The first field is the offset to the first cell, the second is the offset to the last cell.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/domain_ranges.jl#L87-L95">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.data_type" href="#Armon.data_type"><code>Armon.data_type</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">data_type(::ArmonParameters{T})</code></pre><p>Get <code>T</code>, the type used for numbers by the solver</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/parameters.jl#L833-L837">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.@section" href="#Armon.@section"><code>Armon.@section</code></a> — <span class="docstring-category">Macro</span></header><section><div><pre><code class="language-julia hljs">@section(name, expr)
@section(name, options, expr)</code></pre><p>Introduce a profiling section around <code>expr</code>. Sections can be nested. Sections do not introduce a new scope.</p><p>Placed before a for-loop, a new section will be started for each iteration. <code>name</code> can interpolate using loop variables (like <code>Test.@testset</code>).</p><p>It is assumed that a <code>params</code> variable of <code>ArmonParameters</code> is present in the scope of the <code>@section</code>.</p><p><code>options</code> is of the form <code>key=value</code>:</p><ul><li><code>async</code> (default: <code>false</code>): if <code>async=false</code> (and <code>!params.time_async</code>), a barrier (<code>wait(params)</code>) is added at the end of the section.</li></ul><pre><code class="language-julia hljs">params = ArmonParameters(#= ... =#)

@section &quot;Iteration $i&quot; for i in 1:10
    j = @section &quot;Foo&quot; begin
        foo(i)
    end

    @section &quot;Some calculation&quot; begin
        k = bar(i, j)
    end

    @sync begin
        @async begin
            @section &quot;Task 1&quot; async=true my_task_1(i, j, k)
        end

        @async begin
            @section &quot;Task 2&quot; async=true my_task_2(i, j, k)
        end
    end
end</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/profiling.jl#L108-L147">source</a></section></article><h2 id="Grid-and-blocks"><a class="docs-heading-anchor" href="#Grid-and-blocks">Grid and blocks</a><a id="Grid-and-blocks-1"></a><a class="docs-heading-anchor-permalink" href="#Grid-and-blocks" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.BlockGrid" href="#Armon.BlockGrid"><code>Armon.BlockGrid</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">BlockGrid{DeviceA, HostA, BufferA, Ghost, BlockSize, Device}</code></pre><p>Stores <a href="#Armon.TaskBlock"><code>TaskBlock</code></a>s on the <code>Device</code> and host memory, in a grid.</p><p><a href="#Armon.LocalTaskBlock"><code>LocalTaskBlock</code></a> are stored separately depending on if they have a <a href="#Armon.StaticBSize"><code>StaticBSize</code></a> of <code>BlockSize</code> (in <code>device_blocks</code> and <code>host_blocks</code>) or if they have a <a href="#Armon.DynamicBSize"><code>DynamicBSize</code></a> (in <code>device_edge_blocks</code> or <code>host_edge_blocks</code>).</p><p>Blocks have <code>Ghost</code> cells padding their real cells. This is included in their <a href="#Armon.block_size"><code>block_size</code></a>.</p><p><code>DeviceA</code> and <code>HostA</code> are <code>AbstractArray</code> types for the device and host respectively. If <code>DeviceA == HostA</code>, then <code>device_blocks === host_blocks</code>.</p><p><code>BufferA</code> is the type of storage used for MPI buffers. MPI buffers are homogenous: they are either all on the host or all on the device.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/block_grid.jl#L2-L18">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.TaskBlock" href="#Armon.TaskBlock"><code>Armon.TaskBlock</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">TaskBlock{V}</code></pre><p>Abstract block used for cache blocking.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/blocks.jl#L2-L6">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.LocalTaskBlock" href="#Armon.LocalTaskBlock"><code>Armon.LocalTaskBlock</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">LocalTaskBlock{V, Size} &lt;: TaskBlock{V}</code></pre><p>Container of <code>Size</code> and variables of type <code>V</code>, part of a <a href="#Armon.BlockGrid"><code>BlockGrid</code></a>. One block can run all solver steps independantly of all other blocks, apart from those which require updating ghost cells.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/blocks.jl#L13-L18">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.RemoteTaskBlock" href="#Armon.RemoteTaskBlock"><code>Armon.RemoteTaskBlock</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">RemoteTaskBlock{B} &lt;: TaskBlock{B}</code></pre><p>Block located at the border of a <a href="#Armon.BlockGrid"><code>BlockGrid</code></a>, containing MPI buffer of type <code>B</code> for communication with other <a href="#Armon.BlockGrid"><code>BlockGrid</code></a>s.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/blocks.jl#L151-L156">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.BlockState" href="#Armon.BlockState"><code>Armon.BlockState</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">BlockState</code></pre><ul><li><code>Done</code>:    data is up-do-date with the current solver&#39;s state</li><li><code>Working</code>: one thread is working on the block&#39;s data</li><li><code>Waiting</code>: waiting for the completion of another block(s) before continuing work</li></ul><p>At any state, host and device memory are not guarenteed to be synced.</p><p>Two blocks <code>Waiting</code> for each other are able to exchange their neighbouring regions.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/blocking.jl#L233-L243">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.device_to_host!" href="#Armon.device_to_host!"><code>Armon.device_to_host!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">device_to_host!(blk::LocalTaskBlock)</code></pre><p>Copies the device data of <code>blk</code> to its host mirror. <code>blk</code> can be the device or host block. A no-op if the device is the host.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/blocks.jl#L104-L109">source</a></section><section><div><pre><code class="language-julia hljs">device_to_host!(grid::BlockGrid)</code></pre><p>Copies all device data to the host blocks. A no-op if the device is the host.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/block_grid.jl#L480-L484">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.host_to_device!" href="#Armon.host_to_device!"><code>Armon.host_to_device!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">device_to_host!(blk::LocalTaskBlock)</code></pre><p>Copies the host data of <code>blk</code> to its device mirror. <code>blk</code> can be the device or host block. A no-op if the device is the host.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/blocks.jl#L122-L127">source</a></section><section><div><pre><code class="language-julia hljs">device_to_host!(grid::BlockGrid)</code></pre><p>Copies all host data to the device blocks. A no-op if the device is the host.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/block_grid.jl#L492-L496">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.buffers_on_device" href="#Armon.buffers_on_device"><code>Armon.buffers_on_device</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">buffers_on_device(::BlockGrid)
buffers_on_device(::Type{&lt;:BlockGrid})</code></pre><p><code>true</code> if the communication buffers are stored on the device, allowing direct transfers without passing through the host (GPU-aware communication).</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/block_grid.jl#L359-L365">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.device_is_host" href="#Armon.device_is_host"><code>Armon.device_is_host</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">device_is_host(::BlockGrid{D, H})
device_is_host(::Type{&lt;:BlockGrid{D, H}})</code></pre><p><code>true</code> if the device is the host, i.e. device blocks and host blocks are the same (and <code>D == H</code>).</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/block_grid.jl#L350-L355">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.device_blocks" href="#Armon.device_blocks"><code>Armon.device_blocks</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">device_blocks(grid::BlockGrid)</code></pre><p>Simple iterator over all device blocks.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/block_grid.jl#L334-L338">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.host_blocks" href="#Armon.host_blocks"><code>Armon.host_blocks</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">host_blocks(grid::BlockGrid)</code></pre><p>Simple iterator over all host blocks.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/block_grid.jl#L342-L346">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.block_idx" href="#Armon.block_idx"><code>Armon.block_idx</code></a> — <span class="docstring-category">Function</span></header><section><div><p>Linear index of a block in the statically-sized grid</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/block_grid.jl#L235">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.edge_block_idx" href="#Armon.edge_block_idx"><code>Armon.edge_block_idx</code></a> — <span class="docstring-category">Function</span></header><section><div><p>Linear index of a block at the (dynamically-sized) edges of the grid</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/block_grid.jl#L240">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.remote_block_idx" href="#Armon.remote_block_idx"><code>Armon.remote_block_idx</code></a> — <span class="docstring-category">Function</span></header><section><div><p>Linear index of a remote block at the edges of the grid</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/block_grid.jl#L272">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.@iter_blocks" href="#Armon.@iter_blocks"><code>Armon.@iter_blocks</code></a> — <span class="docstring-category">Macro</span></header><section><div><pre><code class="language-julia hljs">@iter_blocks for blk in device_blocks(grid)
    # body...
end</code></pre><p>Applies the body of the for-loop in to all blocks of the <code>grid</code>.</p><p>The body is duplicated for inner and edge blocks, ensuring type-inference.</p><p>If <code>params.use_multithreading</code>, then an attempt will be made at equilibrating workload among threads.</p><pre><code class="language-julia hljs"># Iterate on all device blocks
@iter_blocks for blk in device_blocks(grid)
    some_function(blk)
end

# Iterate on all host blocks
@iter_blocks for blk in host_blocks(grid)
    some_function(blk)
end</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/blocking.jl#L251-L273">source</a></section></article><h3 id="Block-size-and-iteration"><a class="docs-heading-anchor" href="#Block-size-and-iteration">Block size and iteration</a><a id="Block-size-and-iteration-1"></a><a class="docs-heading-anchor-permalink" href="#Block-size-and-iteration" title="Permalink"></a></h3><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.BlockSize" href="#Armon.BlockSize"><code>Armon.BlockSize</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">BlockSize</code></pre><p>Dimensions of a <a href="#Armon.LocalTaskBlock"><code>LocalTaskBlock</code></a>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/blocking.jl#L2-L6">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.StaticBSize" href="#Armon.StaticBSize"><code>Armon.StaticBSize</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">StaticBSize{S, Ghost} &lt;: BlockSize</code></pre><p>A <a href="#Armon.BlockSize"><code>BlockSize</code></a> of size <code>S</code> and <code>Ghost</code> cells. <code>S</code> is embedded in the type, this reduces the amount of memory in the parameters of every kernel, as well as allowing the compiler to make some minor optizations in indexing expressions.</p><p>Ghost cells are included in <code>S</code>: there are <code>S .- 2*Ghost</code> real cells.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/blocking.jl#L10-L18">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.DynamicBSize" href="#Armon.DynamicBSize"><code>Armon.DynamicBSize</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">DynamicBSize{Ghost} &lt;: BlockSize</code></pre><p>Similar to <a href="#Armon.StaticBSize"><code>StaticBSize</code></a>, but for blocks with a less-than-ideal size: block size is therefore not stored in the type. This results in less compilation when testing for different domain sizes with a constant <a href="#Armon.StaticBSize"><code>StaticBSize</code></a>.</p><p>The number of <code>Ghost</code> cells is still embedded in the type, as it can simplify some indexing expressions and for coherency.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/blocking.jl#L37-L46">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.block_size" href="#Armon.block_size"><code>Armon.block_size</code></a> — <span class="docstring-category">Function</span></header><section><div><p><code>NTuple</code> of the dimensions of a <a href="#Armon.BlockSize"><code>BlockSize</code></a></p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/blocking.jl#L25">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.real_block_size" href="#Armon.real_block_size"><code>Armon.real_block_size</code></a> — <span class="docstring-category">Function</span></header><section><div><p><code>NTuple</code> of the dimensions of a <a href="#Armon.BlockSize"><code>BlockSize</code></a>, excluding ghost cells</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/blocking.jl#L31">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.ghosts" href="#Armon.ghosts"><code>Armon.ghosts</code></a> — <span class="docstring-category">Function</span></header><section><div><p>Number of ghost cells of a <a href="#Armon.BlockSize"><code>BlockSize</code></a></p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/blocking.jl#L28">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.border_domain" href="#Armon.border_domain"><code>Armon.border_domain</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">border_domain(bsize::BlockSize, side::Side)</code></pre><p><a href="#Armon.DomainRange"><code>DomainRange</code></a> of the real cells along <code>side</code>. It includes only one &quot;strip&quot; of cells, that is <code>length(border_domain(bsize, side)) == size_along(bsize, side)</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/blocking.jl#L140-L145">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.ghost_domain" href="#Armon.ghost_domain"><code>Armon.ghost_domain</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">ghost_domain(params::ArmonParameters, side::Side)</code></pre><p><a href="#Armon.DomainRange"><code>DomainRange</code></a> of all ghosts cells of <code>side</code>, excluding the corners of the block.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/blocking.jl#L167-L171">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.block_domain_range" href="#Armon.block_domain_range"><code>Armon.block_domain_range</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">block_domain_range(bsize::BlockSize, corners)
block_domain_range(bsize::BlockSize, bottom_left::Tuple, top_right::Tuple)</code></pre><p>A <a href="#Armon.DomainRange"><code>DomainRange</code></a> built from offsets from the corners of <code>bsize</code>.</p><p><code>block_domain_range(bsize, (0, 0), (0, 0))</code> is the domain of all real cells in the block. <code>block_domain_range(bsize, (-g, -g), (g, g))</code> would be the domain of all cells (real cells + <code>g</code> ghost cells) in the block.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/blocking.jl#L61-L70">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.position" href="#Armon.position"><code>Armon.position</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">position(bsize::BlockSize, i)</code></pre><p>N-dim position of the <code>i</code>-th cell in the block.</p><p>If <code>1 ≤ position(bsize, i)[d] ≤ block_size(bsize)[d]</code> then the cell is not a ghost cell along the <code>d</code> dimension. See <a href="#Armon.is_ghost"><code>is_ghost</code></a>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/blocking.jl#L88-L95">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.lin_position" href="#Armon.lin_position"><code>Armon.lin_position</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">lin_position(bsize::BlockSize, I)</code></pre><p>From the <code>NTuple</code> (e.g. returned from <a href="#Armon.position"><code>position</code></a>), return the linear index in the block. <code>lin_position(bsize, position(bsize, i)) == i</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/blocking.jl#L123-L128">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.in_grid" href="#Armon.in_grid"><code>Armon.in_grid</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">in_grid(idx, size)
in_grid(start, idx, size)</code></pre><p><code>true</code> if each axis of <code>idx</code> is between <code>start</code> and <code>size</code>. <code>start</code> defaults to <code>1</code>.</p><p>Argument types can any mix of <code>Integer</code>, <code>Tuple</code> or <code>CartesianIndex</code>.</p><pre><code class="language-julia hljs">julia&gt; in_grid(1, (1, 2), 2)  # same as `in_grid((1, 1), (1, 2), (2, 2))`
true

julia&gt; in_grid((3, 1), (3, 2))
true

julia&gt; in_grid((1, 3), (3, 2))
false</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/blocking.jl#L198-L216">source</a></section><section><div><pre><code class="language-julia hljs">in_grid(idx, grid, axis::Axis)
in_grid(start, idx, grid, axis::Axis)</code></pre><p>Same as <code>in_grid(start, idx, grid)</code>, but only checks along <code>axis</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/blocking.jl#L220-L225">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.is_ghost" href="#Armon.is_ghost"><code>Armon.is_ghost</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">is_ghost(bsize::BlockSize, i, o=0)</code></pre><p><code>true</code> if the <code>i</code>-th cell of the block is a ghost cell, <code>false</code> otherwise.</p><p><code>o</code> would be a &quot;ring&quot; index: <code>o == 1</code> excludes the first ring of ghost cells, etc.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/blocking.jl#L188-L194">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.BlockRowIterator" href="#Armon.BlockRowIterator"><code>Armon.BlockRowIterator</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">BlockRowIterator(grid::BlockGrid; kwargs...)
BlockRowIterator(grid::BlockGrid, blk::LocalTaskBlock; kwargs...)
BlockRowIterator(grid::BlockGrid, sub_grid; global_ghosts=false, all_ghosts=false, device_blocks=true)</code></pre><p>Iterate the rows of all blocks of the <code>grid</code>, row by row (and not block by block). This allows to iterate the cells of the <code>grid</code> as if it was a single block.</p><p>Giving <code>blk</code> will return an iterator on the rows of the block (<code>device_blocks</code> is deduced).</p><p><code>sub_grid</code> defaults to the whole grid: it is a <code>Tuple</code> of iterables, one for each axis.</p><p>If <code>global_ghosts == true</code>, then the ghost cells of at the border of the global domain are also returned. If <code>all_ghosts == true</code>, then the ghost cells of at the border of all blocks are also returned. If <code>device_blocks == false</code>, then host blocks are returned instead of device blocks.</p><pre><code class="language-julia hljs">julia&gt; for (blk, row_range) in BlockRowIterator(grid; all_ghosts=true)
           println(blk.pos, &quot; - &quot;, row_range)
       end
(1, 1) - 1:64
(2, 1) - 1:64
(1, 1) - 65:128
(2, 1) - 65:128
(1, 1) - 129:192
(2, 1) - 129:192
...</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/blocking.jl#L312-L340">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.DomainRange" href="#Armon.DomainRange"><code>Armon.DomainRange</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">DomainRange</code></pre><p>Two dimensional range to index a 2D array stored with contiguous rows. Not equivalent to <code>CartesianIndices</code> as it handles <code>StepRange</code>s properly.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/domain_ranges.jl#L33-L38">source</a></section></article><h2 id="Device-and-backends"><a class="docs-heading-anchor" href="#Device-and-backends">Device and backends</a><a id="Device-and-backends-1"></a><a class="docs-heading-anchor-permalink" href="#Device-and-backends" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.CPU_HP" href="#Armon.CPU_HP"><code>Armon.CPU_HP</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">CPU_HP</code></pre><p>Device tag for the high-performance CPU backend using multithreading (with Polyester.jl) and vectorisation.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/utils.jl#L69-L74">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.create_device" href="#Armon.create_device"><code>Armon.create_device</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">create_device(::Val{:device_name})</code></pre><p>Create a device object from its name.</p><p>Default devices:</p><ul><li><code>:CPU</code>: the CPU backend of <code>KernelAbstractions.jl</code></li><li><code>:CPU_HP</code>: <code>Polyester.jl</code> multithreading</li></ul><p>Extensions:</p><ul><li><code>:Kokkos</code>: the default <code>Kokkos.jl</code> device</li><li><code>:CUDA</code>: the <code>CUDA.jl</code> backend of <code>KernelAbstractions.jl</code></li><li><code>:ROCM</code>: the <code>AMDGPU.jl</code> backend of <code>KernelAbstractions.jl</code></li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/parameters.jl#L640-L653">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.init_backend" href="#Armon.init_backend"><code>Armon.init_backend</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">init_backend(params::ArmonParameters, ::Dev; options...)</code></pre><p>Initialize the backend corresponding to the <code>Dev</code> device returned by <code>create_device</code> using <code>options</code>. Set the <code>params.backend_options</code> field.</p><p>It must return <code>options</code>, with the backend-specific options removed.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/parameters.jl#L661-L668">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.device_memory_info" href="#Armon.device_memory_info"><code>Armon.device_memory_info</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">device_memory_info(device)</code></pre><p>The total and free memory on the device, in bytes.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/parameters.jl#L820-L824">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.memory_info" href="#Armon.memory_info"><code>Armon.memory_info</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">memory_info(params)</code></pre><p>The total and free memory the current process can store on the <code>params.device</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/parameters.jl#L808-L812">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.memory_required" href="#Armon.memory_required"><code>Armon.memory_required</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">memory_required(params::ArmonParameters)</code></pre><p><code>(device_memory, host_memory)</code> required for <code>params</code>.</p><p>MPI buffers are included in the appropriate field depending on <code>params.gpu_aware</code>.</p><p>If <code>device_is_host</code>, then, <code>device_memory</code> only includes memory required by data arrays and MPI buffers.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/block_grid.jl#L369-L377">source</a></section><section><div><pre><code class="language-julia hljs">memory_required(N::NTuple{2, Int}, block_size::NTuple{2, Int}, ghost::Int, data_type)
memory_required(N::NTuple{2, Int}, block_size::NTuple{2, Int}, ghost::Int, DeviceArray, HostArray, BufferArray)</code></pre><p>Compute the number of bytes needed to allocate all blocks. If only <code>data_type</code> is given, then <code>DeviceArray</code>, <code>HostArray</code> and <code>BufferArray</code> default to <code>Vector{T}</code>.</p><p>In order of returned values:</p><ol><li>Amount of bytes needed for all arrays on the device. This amount is also required on the host when the host and device are not the same.</li><li>Amount of bytes needed for all MPI buffers, if the sub-domain has neighbours on all of its sides. If <code>params.gpu_aware</code>, then this memory is allocated on the device.</li><li>Amount of bytes needed on the host memory for all block objects, excluding array data and buffers. This memory is always allocated on the host, and includes device and host blocks objects if <code>DeviceArray != HostArray</code>.</li></ol><pre><code class="nohighlight hljs">res = memory_required((1000, 1000), (64, 64), 4, CuArray{Float64}, Vector{Float64}, Vector{Float64})
device_memory = res[1] + (params.gpu_aware ? res[2] : 0)
host_memory = res[3] + (device_is_host ? device_memory : res[1])</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/blocking/block_grid.jl#L400-L421">source</a></section></article><h2 id="Kernels"><a class="docs-heading-anchor" href="#Kernels">Kernels</a><a id="Kernels-1"></a><a class="docs-heading-anchor-permalink" href="#Kernels" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.@generic_kernel" href="#Armon.@generic_kernel"><code>Armon.@generic_kernel</code></a> — <span class="docstring-category">Macro</span></header><section><div><pre><code class="language-julia hljs">@generic_kernel(function definition)</code></pre><p>Transforms a single kernel function into six different functions:</p><ul><li>4 which run on the CPU using Polyester.jl&#39;s multi-threading or not, as well as SIMD or not.</li><li>one which uses KernelAbstractions.jl to make a GPU-compatible kernel</li><li>a main function, which will take care of calling the two others depending if we want to use the GPU or not.</li></ul><p>To do this, two things are done:</p><ul><li>All calls to <code>@index_1D_lin()</code>, <code>@index_2D_lin()</code> and <code>@iter_idx()</code> are replaced by their equivalent in their respective platforms: a simple loop index for CPUs, and a call to KA.jl&#39;s <code>@index</code> for GPUs.</li><li>Arguments to each function are edited </li></ul><p>A kernel function must call one of <code>@index_1D_lin()</code> or <code>@index_2D_lin()</code> at least once, since this  will determine which type of indexing to use as well as which parameters to add.</p><p>The indexing macro <code>@iter_idx</code> gives the linear index to the current iteration (on CPU) or global  thread (on GPU).</p><p>This means that in order to call the new main function, one needs to take into account which indexing macro was used:</p><ul><li>In all cases, <code>params::ArmonParameters</code> is the first argument</li><li>Then, depending on the indexing macro used:<ul><li><code>@index_1D_lin()</code> : <code>loop_range::OrdinalRange{Int}</code></li><li><code>@index_2D_lin()</code> : <code>main_range::OrdinalRange{Int}</code>, <code>inner_range::OrdinalRange{Int}</code></li></ul></li><li>An optional keyword argument, <code>no_threading</code>, allows to override the <code>use_threading</code> parameter, which can be useful in asynchronous contexts. It defaults to <code>false</code>.</li></ul><p>Using KA.jl&#39;s <code>@Const</code> to annotate arguments is supported, but they will be present only in the GPU kernel definition.</p><p>Further customisation of the kernel and main function can be obtained using <code>@kernel_options</code> and <code>@kernel_init</code>.</p><pre><code class="language-julia hljs">@generic_kernel f_kernel(A)
    i = @index_1D_lin()
    A[i] += 1
end

params.use_gpu = false
f(params, 1:10)  # CPU call

params.use_gpu = true
f(params, 1:10)  # GPU call</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/generic_kernel.jl#L924-L972">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.@kernel_init" href="#Armon.@kernel_init"><code>Armon.@kernel_init</code></a> — <span class="docstring-category">Macro</span></header><section><div><pre><code class="language-julia hljs">@kernel_init(expr)</code></pre><p>Allows to initialize some internal variables of the kernel before the loop. The given expression must NOT depend on any index.  You must not use any indexing macro (<code>@index_1D_lin()</code>, etc...) in the expression.</p><p>All paramerters of the kernel are available during the execution of the init expression. On GPU, this expression will be executed by each thread.</p><p>This is a workaround for a limitation of Polyester.jl which prevents you from typing variables.</p><pre><code class="language-julia hljs">@generic_kernel function simple_kernel(a, b)
    @kernel_init begin
        c::Float64 = sin(0.123)
    end
    i = @index_1D_lin()
    a[i] += b[i] * c
end</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/generic_kernel.jl#L332-L353">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.@kernel_options" href="#Armon.@kernel_options"><code>Armon.@kernel_options</code></a> — <span class="docstring-category">Macro</span></header><section><div><pre><code class="language-julia hljs">@kernel_options(options...)</code></pre><p>Must be used (once, and explicitly) in the definition of a <code>@generic_kernel</code> function.</p><p>Gives options for <code>@generic_kernel</code> to adjust the resulting functions.</p><p>The possible options are:</p><ul><li><code>debug</code>:      Prints the generated functions to stdout at compile time.</li></ul><pre><code class="language-julia hljs">@generic_kernel function add_kernel(a, b)
    @kernel_options(debug)
    i = @index_1D_lin()
    a[i] += b[i]
end</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/generic_kernel.jl#L310-L328">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.@index_1D_lin" href="#Armon.@index_1D_lin"><code>Armon.@index_1D_lin</code></a> — <span class="docstring-category">Macro</span></header><section><div><pre><code class="language-julia hljs">@index_1D_lin()</code></pre><p>Indexing macro to use in a <code>@generic_kernel</code> function.  Returns a linear index to access the 1D arrays used by the kernel.</p><p>Cannot be used alongside <code>@index_2D_lin()</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/generic_kernel.jl#L277-L284">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.@index_2D_lin" href="#Armon.@index_2D_lin"><code>Armon.@index_2D_lin</code></a> — <span class="docstring-category">Macro</span></header><section><div><pre><code class="language-julia hljs">@index_2D_lin()</code></pre><p>Indexing macro to use in a <code>@generic_kernel</code> function.  Returns a linear index to access the 2D arrays used by the kernel.</p><p>Cannot be used alongside <code>@index_1D_lin()</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/generic_kernel.jl#L288-L295">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.@iter_idx" href="#Armon.@iter_idx"><code>Armon.@iter_idx</code></a> — <span class="docstring-category">Macro</span></header><section><div><pre><code class="language-julia hljs">@iter_idx()</code></pre><p>Indexing macro to use in a <code>@generic_kernel</code> function.  Returns a linear index to access the 2D arrays used by the kernel.</p><p>Equivalent to KernelAbstractions.jl&#39;s <code>@index(Global, Linear)</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/generic_kernel.jl#L299-L306">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.@simd_loop" href="#Armon.@simd_loop"><code>Armon.@simd_loop</code></a> — <span class="docstring-category">Macro</span></header><section><div><pre><code class="language-julia hljs">@simd_loop(expr)</code></pre><p>Allows to enable/disable SIMD optimisations for a loop. When SIMD is enabled, it is assumed that there is no dependencies between each iterations of the loop.</p><pre><code class="language-julia hljs">    @simd_loop for i = 1:n
        y[i] = x[i] * (x[i-1])
    end</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/generic_kernel.jl#L190-L201">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.@simd_threaded_iter" href="#Armon.@simd_threaded_iter"><code>Armon.@simd_threaded_iter</code></a> — <span class="docstring-category">Macro</span></header><section><div><pre><code class="language-julia hljs">@simd_threaded_iter(range, expr)</code></pre><p>Same as <code>@simd_threaded_loop(expr)</code>, but instead of slicing the range of the for loop in <code>expr</code>, we slice the <code>range</code> given as the first parameter and distribute the slices evenly to the threads.</p><p>The inner <code>@simd</code> loop assumes there is no dependencies between each iteration.</p><pre><code class="language-julia hljs">    @simd_threaded_iter 4:2:100 for i in 1:100
        y[i] = log10(x[i]) + x[i]
    end
    # is equivalent to (without threading and SIMD)
    for j in 4:2:100
        for i in (1:100) .+ (j - 1)
            y[i] = log10(x[i]) + x[i]
        end
    end</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/generic_kernel.jl#L249-L268">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.@simd_threaded_loop" href="#Armon.@simd_threaded_loop"><code>Armon.@simd_threaded_loop</code></a> — <span class="docstring-category">Macro</span></header><section><div><pre><code class="language-julia hljs">@simd_threaded_loop(expr)</code></pre><p>Allows to enable/disable multithreading and/or SIMD of the loop depending on the parameters. When using SIMD, <code>@fastmath</code> and <code>@inbounds</code> are used.</p><p>In order to use SIMD and multithreading at the same time, the range of the loop is split in even  batches. Each batch has a size of <code>params.simd_batch</code> iterations, meaning that the inner <code>@simd</code> loop has a fixed number of iterations, while the outer threaded loop will have <code>N ÷ params.simd_batch</code> iterations.</p><p>The loop range is assumed to be increasing, i.e. this is correct: 1:2:100, this is not: 100:-2:1 The inner <code>@simd</code> loop assumes there is no dependencies between each iteration.</p><pre><code class="language-julia hljs">    @simd_threaded_loop for i = 1:n
        y[i] = log10(x[i]) + x[i]
    end</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/generic_kernel.jl#L223-L243">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.@threaded" href="#Armon.@threaded"><code>Armon.@threaded</code></a> — <span class="docstring-category">Macro</span></header><section><div><pre><code class="language-julia hljs">@threaded(expr)</code></pre><p>Allows to enable/disable multithreading of the loop depending on the parameters.</p><pre><code class="language-julia hljs">    @threaded for i = 1:n
        y[i] = log10(x[i]) + x[i]
    end</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/generic_kernel.jl#L207-L217">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.@threads" href="#Armon.@threads"><code>Armon.@threads</code></a> — <span class="docstring-category">Macro</span></header><section><div><p>Controls which multi-threading library to use.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/generic_kernel.jl#L7-L9">source</a></section></article><h2 id="Utility"><a class="docs-heading-anchor" href="#Utility">Utility</a><a id="Utility-1"></a><a class="docs-heading-anchor-permalink" href="#Utility" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.Axis" href="#Armon.Axis"><code>Armon.Axis</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">Axis</code></pre><p>Enumeration of the axes of the domain</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/utils.jl#L5-L9">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.Side" href="#Armon.Side"><code>Armon.Side</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">Side</code></pre><p>Enumeration of the sides of the domain</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/utils.jl#L15-L19">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Armon.SolverException" href="#Armon.SolverException"><code>Armon.SolverException</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">SolverException</code></pre><p>Thrown when the solver encounters an invalid state.</p><p>The <code>category</code> field can be used to distinguish between error types without inspecting the error message:</p><ul><li><code>:config</code>: a problem in the solver configuration, usually thrown when constructing <code>ArmonParameters</code></li><li><code>:cpp</code>: a C++ exception thrown by the C++ Kokkos backend</li><li><code>:time</code>: an invalid time step</li></ul><p><code>ErrorException</code>s thrown by the solver represent internal errors.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Armon.jl/blob/71c9817ac2aef00400d243d84dd6ffdde9d08e97/src/utils.jl#L78-L90">source</a></section></article></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.3.0 on <span class="colophon-date" title="Wednesday 6 March 2024 09:52">Wednesday 6 March 2024</span>. Using Julia version 1.9.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
